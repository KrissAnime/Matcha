var users = [
  {
    "first_name": "Crescendo",
    "last_name": "Bester",
    "user_name": "KrissAnime",
    "email": "krissultimatum@gmail.com",
    "password": "",
    "fame_rating": "4",
    "age": "23",
    "gender": "0",
    "sexual_pref": "0",
    "bio": "I am the creator of the site",
    "bio2": "",
    "bio3": "",
    "bio4": "",
    "interests": "Coding, Gaming, Fanfiction, Eating",
    "profile": "001.jpg"
  },
  
  {
    "first_name": "General",
    "last_name": "Esdeath",
    "user_name": "Ice Queen",
    "email": "krissultimatum2+iceqeen@gmail.com",
    "password": "",
    "fame_rating": "5",
    "age": "26",
    "gender": "1",
    "sexual_pref": "0",
    "bio": "Esdeath was a sadist who lacked empathy for people of whom she deemed weak, since she lives by her father's philosophy ('The strong survive and the weak die'). \n",
    "bio2": "She enjoyed putting her enemies through great pain, both physically and emotionally. She had no qualms about killing innocent people to get what she wanted, and rationalized her behavior with her father's old creed.",
    "bio3": "",
    "bio4": "",
    "interests": "Torture, War, Bloodshed, Sadism",
    "profile": "002.jpg"
  },
  
  {
    "first_name": "Leone",
    "last_name": "Lionelle",
    "user_name": "Cat Girl",
    "email": "krissultimatum2+catgirl@gmail.com",
    "password": "",
    "fame_rating": "4.5",
    "age": "21",
    "gender": "1",
    "sexual_pref": "3",
    "bio": "She has a very relaxed, upbeat, and cheerful personality, and tends to display a lack of ladylike manners, often seen shoving Tatsumi into her breasts, putting her feet on the table, or consuming large amounts of sake. \n",
    "bio2": "She serves as a sort of big sister figure to Tatsumi and younger members in Night Raid, often referring to herself as 'onee-san'.\n",
    "bio3": "Despite the morally dodgy nature that she sometimes displayed, Leone is not one to tolerate injustice, and can be especially vicious to those who commit the vilest of acts. She also enjoys fighting her enemies a lot, as said by Najenda who told her that she needs to change that habit.",
    "bio4": "",
    "interests": "Drinking, Fighting, Relaxing",
    "profile": "003.jpg"
  },
  
  {
    "first_name": "Sarah",
    "last_name": "Kerrigan",
    "user_name": "Queen of Blades",
    "email": "krissultimatum+bladequeen@gmail.com",
    "password": "",
    "fame_rating": "5",
    "age": "35",
    "gender": "1",
    "sexual_pref": "3",
    "bio": "Sarah Louise Kerrigan was a psychic terran female. She began her career as a Confederate ghost and later became the second-in-command of the Sons of Korhal. Following Arcturus Mengsk's betrayal, she was captured and infested by the Zerg Swarm, ultimately becoming the self-proclaimed Queen of Blades (a.k.a. the Zerg Queen) and leader of the Swarm.",
    "bio2": "At the Dominion Ghost Academy, ghosts in training are told the Confederacy allowed Kerrigan to 'defect' to the zerg. Non-control zerg strains referred to her as 'the Kerrigan.'",
    "bio3": "",
    "bio4": "",
    "interests": "Ruling the Swarm, Killing Acturus",
    "profile": "004.jpg"
  },
  
  {
    "first_name": "November",
    "last_name": "Terra",
    "user_name": "Nova",
    "email": "krissultimatum2+nova@gmail.com",
    "password": "",
    "fame_rating": "4",
    "age": "23",
    "gender": "1",
    "sexual_pref": "1",
    "bio": "November 'Nova' Terra was a member of the Terra family, one of the Terran Confederacy's rich and powerful 'Old Families'.\n",
    "bio2": "She is the youngest child of Bella and Constantino Terra, and had two siblings -- Clara and Zeb.\n",
    "bio3": "The family lived in the Terra Skyscraper in Tarsonis City, Tarsonis. She possessed a degree of empathy that was generally lacking in the Old Families, a trait that did not go unnoticed.\n",
    "bio4": "She also believed strongly in the concept of fair play. She was regarded as the 'golden child' of the family.",
    "interests": "Covert Ops, Sniping, Hacking",
    "profile": "005.jpg"
  },
  
  {
    "first_name": "Orphea",
    "last_name": "Raven",
    "user_name": "Raven Girl",
    "email": "krissultimatum+ravengirl@gmail.com",
    "password": "",
    "fame_rating": "3.5",
    "age": "18",
    "gender": "1",
    "sexual_pref": "1",
    "bio": "Orphea's upbringing was lonely, but she found comfort and connection with ancestral magic. Orphea's mother left the family early in Orphea's life, fearing what would happen if her father Oberon, Raven Lord, tapped into the Dark Nexus.\n",
    "bio2": "Oberon promised Orphea not to tap into this power, but he broke this promise, pushing Orphea away. Later her father sends out Knights to find her.\n",
    "bio3": "While Deckard Cain wanders around the forests of Dragon Shire, he is attacked by those knights. Orphea joins the clash and helps Cain defeating the knights. Deckard Cain and Orphea team up to find a solution for the Dark Nexus threat raised by the Raven Lord. They come to Raena the Lady of Thorns and Realm Lord of Dragon Shire, for help and warn her about the danger coming. Raena calls on her greatest allies from across the lands and marches with them forward to battle the Raven Lord and his champions in Alterac Pass.",
    "bio4": "Later Orphea witnessed her father defeating the Lady of Thorns and causing the fall of King's Crest. Vowing to stop her father from hurting anyone else, she chose to rise up against him and become a hero in the Nexus.",
    "interests": "Nexus Battles, Dragon Riding, Ancestral Magic, Commentating",
    "profile": "006.jpg"
  },
  
  {
    "first_name": "Bulat",
    "last_name": "Incursio",
    "user_name": "Tyrant",
    "email": "krissultimatum+tyrant@gmail.com",
    "password": "",
    "fame_rating": "3",
    "age": "27",
    "gender": "0",
    "sexual_pref": "2",
    "bio": "Bulat had a calm, kind personality; although he referred to himself as passionate and hot-blooded, he never actually lost his cool in battle.\n",
    "bio2": "He was among the most compassionate members of the Night Raid and he taught Tatsumi to embrace these emotions but not to let them consume him.\n",
    "bio3": "Leone informed Tatsumi that Bulat was gay, to which he replied, 'You don't want him to misunderstand, right?', but did not deny Leone's statement, while blushing heavily.\n",
    "bio4": "Bulat flirted with Tatsumi on occasion, which made the latter extremely nervous.",
    "interests": "Exercise, Styling Hair, Tatsumi",
    "profile": "007.jpg"
  },
  
  {
    "first_name": "Erza",
    "last_name": "Scarlet",
    "user_name": "Titania",
    "email": "krissultimatum+titania@gmail.com",
    "password": "",
    "fame_rating": "4",
    "age": "26",
    "gender": "1",
    "sexual_pref": "1",
    "bio": "Erza is a very strict person, often criticizing the bad behavior and habits of the other guild members, causing most of them to apologize, fearing that they might invoke her wrath.\n",
    "bio2": "She is also very impatient, disliking people who don't answer her questions quickly enough.\n",
    "bio3": "",
    "bio4": "",
    "interests": "Discipline, BDSM, Erotic Novels, Fighting",
    "profile": "008.jpg"
  },
  {
    "first_name": "Shirou",
    "last_name": "Emiya",
    "user_name": "Archer",
    "email": "krissultimatum+archer@gmail.com",
    "password": "",
    "fame_rating": "3",
    "age": "28",
    "gender": "0",
    "sexual_pref": "1",
    "bio": "While he is thoroughly cynical and nihilistic, he is at the same time devoted and protective, and even a little childish to the point that it makes him hard to hate.\n",
    "bio2": "He does not lie, but he does keep secrets and tell half truths.\n",
    "bio3": "He means well and is capable of being nice, but often ends up being sarcastic, especially so when he gives advice.",
    "bio4": "",
    "interests": "Housework, Archery, Tinkering",
    "profile": "009.jpg"
  },
];

const fs = require('fs');
var crypto = require('crypto');
var mysql = require('mysql');

var con = mysql.createConnection({
  socketPath: '/goinfre/cbester/Desktop/mamp_server/mysql/tmp/mysql.sock',
  host: "localhost",
  user: "root",
  password: "Asuka2016"
});

var db_name = "matcha";

function encryption(password){
  var master_key = crypto.createHash('sha512');
  master_key.update(password);
  var hash = master_key.digest('hex');
  return hash;
}

con.connect(function(err) {
  if (err){
    console.log(err);
  }
  else{
    console.log("Connected To Server!");
  }
  
  var sql = "CREATE DATABASE IF NOT EXISTS ";
  sql += db_name;
  con.query(sql, function (err, result) {
    if (err){
      console.log(err);
    }
    else{
      console.log("Database Created");
    }
  });
});

sql = "CREATE TABLE IF NOT EXISTS `matcha`.`users`";
sql += "(`unique_key` VARCHAR(255) NOT NULL PRIMARY KEY ,";
sql += " `user_name` VARCHAR(50) NOT NULL ,";
sql += " `email` VARCHAR(50) NOT NULL ,";
sql += " `password` VARCHAR(255) NOT NULL,";
sql += " `verified` INT (1),";
sql += " `profile` VARCHAR(60),";
sql += " `date` DATETIME DEFAULT CURRENT_TIMESTAMP)"
con.query(sql, function (err, result) {
  if (err){
    console.log(err);
  }
  else{
    console.log("Users Table Created");
  }
});

sql = "CREATE TABLE IF NOT EXISTS `matcha`.`profiles`";
sql += "(`unique_key` VARCHAR(255) NOT NULL PRIMARY KEY,";
sql += " `profile` VARCHAR(60) ,";
sql += " `first_name` VARCHAR(30) NOT NULL ,";
sql += " `last_name` VARCHAR(30) NOT NULL ,";
sql += " `user_name` VARCHAR(50) NOT NULL ,";
sql += " `fame_rating` INT(1) DEFAULT '0' ,";
sql += " `age` INT(2) ,";
sql += " `gender` VARCHAR(7) ,";
sql += " `sexual_pref` VARCHAR(10) ,";
sql += " `location_lat` FLOAT(10,6) ,";
sql += " `location_long` FLOAT(10,6) ,";
sql += " `bio` VARCHAR(1500) ,";
sql += " `interests` VARCHAR(1000)) ENGINE = InnoDB";
con.query(sql, function (err, result) {
  if (err){
    console.log(err);
  }
  else{
    console.log("Profiles Table Created");
  }
});

sql = "CREATE TABLE IF NOT EXISTS `matcha`.`images` ";
sql += "(`unique_key` VARCHAR(255) NOT NULL PRIMARY KEY ,";
sql += " `profile` VARCHAR(60) DEFAULT 'NULL' ,";
sql += " `img_01` VARCHAR(255) DEFAULT 'NULL' ,";
sql += " `img_02` VARCHAR(255) DEFAULT 'NULL' ,";
sql += " `img_03` VARCHAR(255) DEFAULT 'NULL' ,";
sql += " `img_04` VARCHAR(255) DEFAULT 'NULL' )";
sql += "ENGINE = InnoDB;";
con.query(sql, function (err, result) {
  if (err){
    console.log(err);
  }
  else{
    console.log("Images Table Created");
  }
});

sql = "CREATE TABLE IF NOT EXISTS `matcha`.`tags` ";
sql += "(`tag_id` INT(3) NOT NULL AUTO_INCREMENT PRIMARY KEY ,";
sql += " `tag_name` VARCHAR(30) NOT NULL) ENGINE = InnoDB;";
con.query(sql, function (err, result) {
  if (err){
    console.log(err);
  }
  else{
    console.log("Tags Table Created");
  }
});

sql = "CREATE TABLE IF NOT EXISTS `matcha`.`likes` ";
sql += "(`like_id` INT(6) AUTO_INCREMENT PRIMARY KEY, `instigator` VARCHAR(255) NOT NULL , `receiver` VARCHAR(255) NOT NULL, ";
sql += " `choice` VARCHAR(6), `time_log` DATETIME DEFAULT CURRENT_TIMESTAMP, `rating` INT(1)) ENGINE = InnoDB;";
con.query(sql, function (err, result) {
  if (err){
    console.log(err);
  }
  else{
    console.log("Likes Table Created");
  }
});

sql = "CREATE TABLE IF NOT EXISTS `matcha`.`messaging` ";
sql += "(`message_log` INT(10) AUTO_INCREMENT PRIMARY KEY, `sender` VARCHAR(255) NOT NULL , `receiver` VARCHAR(255) NOT NULL, ";
sql += " `message` VARCHAR(1000), `time_log` DATETIME DEFAULT CURRENT_TIMESTAMP) ENGINE = InnoDB;";
con.query(sql, function (err, result) {
  if (err){
    console.log(err);
  }
  else{
    console.log("Messaging Table Created");
  }
});

sql = "CREATE TABLE IF NOT EXISTS `matcha`.`block` ";
sql += "(`block_id` INT(6) AUTO_INCREMENT PRIMARY KEY, `sender` VARCHAR(255) NOT NULL , `receiver` VARCHAR(255) NOT NULL, ";
sql += " `status` BOOLEAN, `time_log` DATETIME DEFAULT CURRENT_TIMESTAMP) ENGINE = InnoDB;";
con.query(sql, function (err, result) {
  if (err){
    console.log(err);
  }
  else{
    console.log("Block Table Created");
  }
});

sql = "CREATE TABLE IF NOT EXISTS `matcha`.`user_tags`";
sql += "(`user_tag_id` INT(8) AUTO_INCREMENT PRIMARY KEY, `unique_key` VARCHAR(255), `tag_name` VARCHAR(30) NOT NULL) ENGINE = InnoDB;";
con.query(sql, function(err, result){
    if (err){
        console.log(err);
    }
    else{
        console.log("User Tags Table Created");
    }
})

sql = "CREATE TABLE IF NOT EXISTS `matcha`.`rating` ";
sql += "(`rating_id` INT(9) AUTO_INCREMENT PRIMARY KEY, `rator` VARCHAR(255) NOT NULL , `rated` VARCHAR(255) NOT NULL ,";
sql += " `rating` INT(1) NOT NULL) ENGINE = InnoDB;";
con.query(sql, function (err, result) {
  if (err){
    console.log(err);
  }
  else{
    console.log("Rating Table Created");
  }
});

sql = "CREATE TABLE IF NOT EXISTS `matcha`.`verification` ";
sql += "(`email` VARCHAR(50) NOT NULL PRIMARY KEY ,";
sql += " `code` VARCHAR(255) NOT NULL) ENGINE = InnoDB;";
con.query(sql, function (err, result) {
  if (err){
    console.log(err);
  }
  else{
    console.log("Verification Table Created");
  }
});

sql = "CREATE TABLE IF NOT EXISTS `matcha`.`notifications` ";
sql += "(`notice_id` INT (9) AUTO_INCREMENT PRIMARY KEY, `user_name` VARCHAR(50) NOT NULL, `action` VARCHAR(30) NOT NULL, `instigator` VARCHAR(50) NOT NULL, ";
sql += " `notify` VARCHAR(300) NOT NULL, `time_log` DATETIME DEFAULT CURRENT_TIMESTAMP, `logged` INT(1)) ENGINE = InnoDB;";
con.query(sql, function (err, result) {
  if (err){
    console.log(err);
  }
  else{
    console.log("Notification Table Created");
  }
});

function escapeHtml(unsafe) {
  return unsafe
  .replace(/&/g, "&amp;")
  .replace(/</g, "&lt;")
  .replace(/>/g, "&gt;")
  .replace(/"/g, "&quot;")
  .replace(/'/g, "&#039;");
}


var x = 0;
for (const item of users){
  var pass = encryption(item.password);
  var email = item.email;
  var user_name = item.user_name;
  var profile = item.profile;
  var gender = item.gender;
  var first_name = item.first_name;
  var last_name = item.last_name;
  var bio = escapeHtml(item.bio + item.bio2 + item.bio3 + item.bio4);
  var fame_rating = item.fame_rating;
  var gender = item.gender;
  var sexual_pref = item.sexual_pref;
  var interests = item.interests;
  var age = item.age;
  var unique_key = encryption(user_name);
  const dir = "./public/extra/profiles/";
  
  // console.log("Before new loop");
  var temp_dir = dir + user_name;
  sql = "INSERT INTO `matcha`.`images` ";
  sql += "(`unique_key`, `profile`) ";
  sql += "VALUES ('" + unique_key + "', '" + profile + "')";
  con.query(sql, function (err, result) {
    if (err){
      console.log(err);
    }
    else{
      console.log("User Inserted Into Image Table!");
    }
  });
  var index = 1;
  fs.readdirSync(temp_dir).forEach(file => {
    if (file[0] != "." && index < 5 && file.length > 7){
      sql = "UPDATE `matcha`.`images` SET `img_0" + index + "` = ";
      sql += "'" + file + "' WHERE `images`.`unique_key` = '" + unique_key + "'";
      index++;
      con.query(sql, function (err, result) {
        if (err){
          console.log(err);
        }
        else{
          console.log(result.affectedRows + " record(s) updated");
        }
      });
    }    
  });
  sql = "INSERT INTO `matcha`.`users` ";
  sql += "(`unique_key`, `user_name`, `email`, `password`, `verified`, `profile`)";
  sql += " VALUES ('" + unique_key + "', '" + user_name + "', '" + email + "', '";
  sql += pass + "', '1" + "', '" + profile + "')";
  con.query(sql, function (err, result) {
    if (err){
      console.log(err);
    }
    else{
      console.log("User Created!");
    }
  });
  
  sql = "INSERT INTO `matcha`.`profiles` ";
  sql += "(`unique_key`, `profile`, `first_name`, `last_name`, `user_name`, `fame_rating`, `age`, `gender`, ";
  sql +=  "`sexual_pref`, `bio`, `interests`)";
  sql += " VALUES ('" + unique_key + "', '"  + profile + "', '" + first_name + "', '" + last_name + "', '";
  sql += user_name +  "', '" + fame_rating + "', '" + age + "', '";
  sql += gender +  "', '" + sexual_pref + "', '" + bio + "', '" + interests + "')";
  con.query(sql, function (err, result) {
    if (err){
      console.log(err);
    }
    else{
      console.log("Profile Entry Created!");
    }
  });
  x++;
}